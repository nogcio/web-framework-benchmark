name: Reusable Benchmark Test

on:
  workflow_call:
    inputs:
      framework_path:
        required: true
        type: string
        description: "Path to the framework directory (e.g., benchmarks/go/std)"
      image_tag:
        required: true
        type: string
        description: "Tag for the docker image (e.g., wfb-go-std)"
      tests:
        required: true
        type: string
        description: "Comma-separated or JSON array with tests to run (hello_world, json, db_read_one, db_read_paging, db_write, static_files_small, static_files_medium, static_files_large)"
      database:
        required: false
        type: string
        default: ""
        description: "Database kind to start for DB-related tests (postgres, mysql, mssql). Leave empty when no DB is needed."
      port:
        required: false
        type: string
        default: "8000"
        description: "Port the app listens on inside the container"

jobs:
  test:
    runs-on: ubuntu-latest
    env:
      APP_PORT: ${{ inputs.port }}

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build database image (if required)
      if: inputs.database != ''
      run: |
        set -euo pipefail
        db_input="${{ inputs.database }}"
        db_kind=$(echo "$db_input" | tr '[:upper:]' '[:lower:]')
        case "$db_kind" in
          postgres|pg|postgresql)
            db_dir="pg"
            db_kind="postgres"
            db_port=5432
            ;;
          mysql)
            db_dir="mysql"
            db_kind="mysql"
            db_port=3306
            ;;
          mariadb)
            db_dir="mariadb"
            db_kind="mariadb"
            db_port=3306
            ;;
          mssql|sqlserver)
            db_dir="mssql"
            db_kind="mssql"
            db_port=1433
            ;;
          *)
            echo "Unsupported database: $db_input"
            exit 1
            ;;
        esac

        {
          echo "DB_DIR=$db_dir"
          echo "DB_PORT=$db_port"
          echo "DB_KIND=$db_kind"
        } >> "$GITHUB_ENV"

        docker build -t "wfb-db:${db_kind}" "benchmarks_db/${db_dir}"

    - name: Start database container (if required)
      if: inputs.database != ''
      run: |
        set -euo pipefail
        db_envs=()
        case "$DB_KIND" in
          postgres)
            db_envs+=(
              -e POSTGRES_DB=benchmark
              -e POSTGRES_USER=benchmark
              -e POSTGRES_PASSWORD=benchmark
            )
            ;;
          mysql)
            db_envs+=(
              -e MYSQL_DATABASE=benchmark
              -e MYSQL_USER=benchmark
              -e MYSQL_PASSWORD=benchmark
              -e MYSQL_ROOT_PASSWORD=benchmark
            )
            ;;
          mariadb)
            db_envs+=(
              -e MARIADB_DATABASE=benchmark
              -e MARIADB_USER=benchmark
              -e MARIADB_PASSWORD=benchmark
              -e MARIADB_ROOT_PASSWORD=benchmark
            )
            ;;
          mssql)
            db_envs+=(
              -e ACCEPT_EULA=Y
              -e MSSQL_SA_PASSWORD=Benchmark!12345
              -e MSSQL_PID=Developer
            )
            ;;
        esac

        docker run -d \
          --name wfb-db \
          --network host \
          "${db_envs[@]}" \
          "wfb-db:${DB_KIND}"

    - name: Wait for database to be ready
      if: inputs.database != ''
      run: |
        set -euo pipefail
        case "$DB_KIND" in
          postgres)
            for _ in $(seq 1 60); do
              if docker run --rm --network host postgres:18 pg_isready -h 127.0.0.1 -p "${DB_PORT}" -U benchmark >/dev/null 2>&1; then
                exit 0
              fi
              sleep 2
            done
            echo "Postgres did not become ready" && exit 1
            ;;
          mysql)
           ariadb)
            for _ in $(seq 1 60); do
              if docker exec wfb-db mariadb-admin ping -h127.0.0.1 -P"${DB_PORT}" -ubenchmark -pbenchmark --silent; then
                exit 0
              fi
              sleep 2
            done
            echo "MariaDB did not become ready" && exit 1
            ;;
          m for _ in $(seq 1 60); do
              if docker exec wfb-db mysqladmin ping -h127.0.0.1 -P"${DB_PORT}" -ubenchmark -pbenchmark --silent; then
                exit 0
              fi
              sleep 2
            done
            echo "MySQL did not become ready" && exit 1
            ;;
          mssql)
            for _ in $(seq 1 90); do
              if docker exec -e MSSQL_SA_PASSWORD=Benchmark!12345 wfb-db /usr/config/check_ready.sh >/dev/null 2>&1; then
                exit 0
              fi
              sleep 2
            done
            echo "MSSQL did not become ready" && exit 1
            ;;
        esac

    - name: Create test data fixtures
      run: |
        set -euo pipefail
        mkdir -p benchmarks_data
        dd if=/dev/zero of=benchmarks_data/15kb.bin bs=1024 count=15
        dd if=/dev/zero of=benchmarks_data/1mb.bin bs=1024 count=1024
        dd if=/dev/zero of=benchmarks_data/10mb.bin bs=1024 count=10240

    - name: Build Docker image for benchmark
      uses: docker/build-push-action@v5
      with:
        context: ./${{ inputs.framework_path }}
        tags: ${{ inputs.image_tag }}
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Run benchmark container
      run: |
        set -euo pipefail
        extra_env=()
        if [ -n "${{ inputs.database }}" ]; then
          extra_env+=(
            -e DB_HOST=127.0.0.1
            -e DB_PORT="${DB_PORT}"
            -e DB_USER=benchmark
            -e DB_NAME=benchmark
            -e DB_KIND="${DB_KIND}"
          )
          case "$DB_KIND" in
            postgres|mysql)
              extra_env+=( -e DB_PASSWORD=benchmark )
              ;;
            mssql)
              extra_env+=( -e DB_PASSWORD=Benchmark!12345 )
              ;;
          esac
        fi

        docker run -d \
          --network host \
          --name ${{ inputs.image_tag }} \
          -e PORT="${APP_PORT}" \
          -e DATA_DIR=/app/benchmarks_data \
          "${extra_env[@]}" \
          -v "$PWD/benchmarks_data:/app/benchmarks_data" \
          ${{ inputs.image_tag }}

    - name: Wait for app to become ready
      run: |
        set -euo pipefail
        for _ in $(seq 1 60); do
          if curl -fsS "http://localhost:${APP_PORT}/health" >/dev/null 2>&1; then
            exit 0
          fi
          sleep 2
        done
        echo "App did not become ready" && exit 1

    - name: Run smoke tests for selected benchmarks
      env:
        TESTS_INPUT: ${{ inputs.tests }}
      run: |
        set -euo pipefail

        tests=$(python3 .github/scripts/ci_parse_tests.py "$TESTS_INPUT")
        if [ -z "$tests" ]; then
          echo "No tests provided" >&2
          exit 1
        fi

        mapfile -t tests_array <<<"$tests"
        base_url="http://localhost:${APP_PORT}"

        # Always verify health first
        curl -v -f "${base_url}/health"

        for test in "${tests_array[@]}"; do
          echo "Running test: $test"
          case "$test" in
            hello_world)
              curl -v -f "${base_url}/"
              ;;
            json)
              curl -v -f -X POST -H "Content-Type: application/json" \
                -d '{"web-app":{"servlet":[{"servlet-name":"old"}]}}' \
                "${base_url}/json/old/new"
              ;;
            db_read_one)
              curl -v -f "${base_url}/db/read/one?id=1"
              ;;
            db_read_paging)
              curl -v -f "${base_url}/db/read/many?offset=0&limit=10"
              ;;
            db_write)
              curl -v -f -X POST "${base_url}/db/write/insert?name=ci_insert"
              ;;
            static_files_small)
              curl -v -f "${base_url}/files/15kb.bin" > /dev/null
              ;;
            static_files_medium)
              curl -v -f "${base_url}/files/1mb.bin" > /dev/null
              ;;
            static_files_large)
              curl -v -f "${base_url}/files/10mb.bin" > /dev/null
              ;;
            *)
              echo "Unknown test name: $test" >&2
              exit 1
              ;;
          esac
        done

    - name: Show container logs on failure
      if: failure()
      run: |
        docker logs ${{ inputs.image_tag }} || true
        if [ -n "${{ inputs.database }}" ]; then
          docker logs wfb-db || true
        fi

    - name: Stop containers
      if: always()
      run: |
        docker stop ${{ inputs.image_tag }} >/dev/null 2>&1 || true
        docker rm ${{ inputs.image_tag }} >/dev/null 2>&1 || true
        if [ -n "${{ inputs.database }}" ]; then
          docker stop wfb-db >/dev/null 2>&1 || true
          docker rm wfb-db >/dev/null 2>&1 || true
        fi
