worker_processes auto;
error_log stderr error;

events {
    worker_connections 16384;
}

http {
    access_log off;
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";

    server {
        listen 8080;

        location / {
            default_type text/plain;
            content_by_lua_block {
                ngx.print("Hello, World!")
            }
        }

        location /plaintext {
            default_type text/plain;
            content_by_lua_block {
                ngx.print("Hello, World!")
            }
        }

        location /health {
            default_type text/plain;
            content_by_lua_block {
                ngx.print("OK")
            }
        }

        location ~ ^/json/([^/]+)/([^/]+)$ {
            default_type application/json;
            
            content_by_lua_block {
                local cjson = require "cjson"
                local from_val = ngx.var[1]
                local to_val = ngx.var[2]

                ngx.req.read_body()
                local body_data = ngx.req.get_body_data()

                if not body_data then
                    ngx.status = 400
                    ngx.say("No body")
                    return
                end

                local json_body = cjson.decode(body_data)

                local function replace_values(tbl)
                    for k, v in pairs(tbl) do
                        if type(v) == "table" then
                            replace_values(v)
                        elseif k == "servlet-name" and v == from_val then
                            tbl[k] = to_val
                        end
                    end
                end

                replace_values(json_body)

                -- Handle X-Request-ID
                local req_id = ngx.req.get_headers()["X-Request-ID"]
                if req_id then
                    ngx.header["X-Request-ID"] = req_id
                end

                ngx.print(cjson.encode(json_body))
            }
        }
    }
}
